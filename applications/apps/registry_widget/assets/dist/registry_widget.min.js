!function($){function bind_search(obj,s){if(s.lookup){var lookup_btn=$("<button>").html(s.lookup_btn_text).addClass(s.lookup_btn_class);obj.p.append(lookup_btn),$(lookup_btn).on("click",function(e){e.preventDefault(),e.stopPropagation(),_lookup(obj.val(),obj,s)})}if(s.search){var search_btn=$("<button>").addClass(s.search_btn_class).html(s.search_btn_text);if(obj.p.append(search_btn),$(search_btn).on("click",function(e){e.preventDefault(),e.stopPropagation(),_search(obj,s)}),s.auto_search&&""!=obj.val()&&_search(obj,s),s.advanced){var advanced_btn=$("<button>").addClass("btn btn-link").html("Advanced");obj.p.append(advanced_btn)}}}function _search(obj,s){obj.val();$.ajax({url:s.proxy+"search?q="+obj.val()+"&callback=?",dataType:"jsonp",timeOut:5e3,success:function(data){if(0==data.status)if(s.search_callback&&"function"==typeof s.search_callback)s.search_callback(data,obj,s);else{var template=s.result_template;$(".rowidget_results",obj.p).remove(),$(".ro_widget_single",obj.p).remove(),obj.p.append(template.renderTpl(data.result)),$(".rowidget_results li",obj.p).on("click",function(e){e.preventDefault(),obj.val($("a",this).attr("data-"+s.return_type)),_lookup(obj.val(),obj,s),$(".rowidget_results",obj.p).remove()})}else $(".rowidget_results",obj.p).remove(),obj.p.append('<div class="rowidget_results">'+data.message+"</div>")}})}function bind_display_single(obj,s){"undefined"!=typeof obj.attr("data-query")&&_lookup(obj.attr("data-query"),obj,s)}function _lookup(query,obj,s){$.ajax({url:s.proxy+"lookup?q="+encodeURIComponent(query)+"&callback=?",dataType:"jsonp",timeOut:5e3,success:function(data){if(0==data.status)if(s.lookup_callback&&"function"==typeof s.lookup_callback)s.lookup_callback(data,obj,s);else{var template=s.single_template;$(".rowidget_single",obj.p).remove(),obj.p.append(template.renderTpl(data.result)),s.return_type&&"undefined"!=typeof data.result[s.return_type]&&obj.val(data.result[s.return_type])}}})}function bind_display_result(obj,s){"undefined"!=typeof obj.attr("data-query")&&$.ajax({url:s.proxy+"search?custom_q="+encodeURIComponent(obj.attr("data-query"))+"&callback=?",dataType:"jsonp",timeOut:5e3,success:function(data){if(0==data.status){var template=s.result_template;$(".rowidget_single",obj.p).remove(),obj.p.append(template.renderTpl(data.result)),s.return_type&&"undefined"!=typeof data.result[s.return_type]&&obj.val(data.result[s.return_type])}}})}var WIDGET_NAME="ANDS Registry service",WIDGET_ID="_registry_widget_list";$.fn.registry_widget=function(options,param){param="undefined"==typeof param?!1:param;var defaults={proxy:"http://researchdata.ands.org.au/apps/registry_widget/proxy/",mode:"search",search:!0,advanced:!1,auto_search:!1,wrapper:'<div class="rowidget_wrapper"></div>',search_btn_text:"Search",search_btn_class:"rowidget_search btn btn-small btn-default",search_callback:!1,lookup:!1,auto_lookup:!1,lookup_btn_text:"Resolve",lookup_btn_class:"rowidget_lookup btn btn-small btn-default",lookup_callback:!1,result_template:'<ul class="rowidget_results">{{#docs}}<li><a href="javascript:;" data-key="{{key}}" data-slug="{{slug}}" data-id="{{id}}">{{list_title}}</a></li>{{/docs}}</ul>',single_template:'<div class="rowidget_single"><h4><a href="{{rda_link}}" target="_blank">{{title}}</a></h4><span class="text-muted">{{group}}</span><div class="description">{{description}}</div></div>',return_type:"key"};"undefined"!=typeof window.real_base_url&&(defaults.proxy=window.real_base_url+"apps/registry_widget/proxy/");var settings;if("string"!=typeof options){settings=$.extend({},defaults,options),settings.list_class="undefined"==typeof settings.list_class?"":settings._wname=WIDGET_NAME,settings._wid=WIDGET_ID;try{return this.each(function(){var $this=$(this);$this.wrap(settings.wrapper),$this.p=$this.parent(),("display_single"==$this.attr("data-mode")||"display_result"==$this.attr("data-mode"))&&(settings.mode=$this.attr("data-mode")),$this.is("input")&&"search"==settings.mode?bind_search($this,settings):"display_single"==settings.mode?bind_display_single($this,settings):"display_result"==settings.mode&&bind_display_result($this,settings)})}catch(err){throw err}}},String.prototype.renderTpl=function(){var args=arguments;if("undefined"==typeof args[0])return this;var values=args[0];return template=this.replace(/{{#(.*?)}}([\s\S]*?){{\/\1}}/g,function(match,subTplName,subTplValue){if("undefined"!=typeof values[subTplName]&&values[subTplName]instanceof Array&&values[subTplName].length>0){for(replacement="",i=0;i<values[subTplName].length;i++){var partial=subTplValue.renderTpl(values[subTplName][i]);partial!=subTplValue&&(replacement+=partial)}return""!=replacement?replacement:subTplValue}return""}),template.replace(/{{([\s\S]*?)}}/g,function(match,field_name){return"undefined"!=typeof values[field_name]?values[field_name]:match})},$(".registry_widget").each(function(){{var elem=$(this);elem.registry_widget()}})}(jQuery);