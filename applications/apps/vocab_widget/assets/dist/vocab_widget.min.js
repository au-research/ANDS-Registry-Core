!function($){var WIDGET_NAME="ANDS Vocabulary Widget service",WIDGET_ID="_vocab_widget_list",WIDGET_DATA="vocab_data";$.fn.vocab_widget=function(options,param){function _alert(msg){alert(WIDGET_NAME+": \r\n"+msg+"\r\n(reload the page before retrying)")}param="undefined"==typeof param?!1:param;var defaults={endpoint:"http://researchdata.ands.org.au/apps/vocab_widget/proxy/",repository:"",mode:"",mode_params:"",max_results:100,min_chars:3,delay:500,cache:!0,nohits_msg:"No matches found",error_msg:WIDGET_NAME+" error.",list_class:"vocab_list",fields:["label","notation","about"],target_field:"label",sqc:"",sqc_op:"",display_count:!0};"undefined"!=typeof window.real_base_url&&(defaults.endpoint=window.real_base_url+"apps/vocab_widget/proxy/");var settings,handler;if("string"==typeof options)return this.each(function(){var op=options,$this=$(this);switch(handler=$this.data("_handler"),("undefined"==typeof handler||"core"!==handler._mode())&&_alert("Plugin handler not found; instantiate with no arguments before using, or use a UI helper mode"),op){case"search":handler._search(param);break;case"narrow":handler._narrow(param);break;case"top":handler._top(param);break;case"collection":handler._collection(param);break;default:"undefined"!=typeof defaults[op]?handler.settings[op]=param:_alert("invalid operation '"+op+"'")}});settings=$.extend({},defaults,options),settings.list_class="undefined"==typeof settings.list_class?"":settings.list_class,settings._wname=WIDGET_NAME,settings._wid=WIDGET_ID;try{return this.each(function(){var $this=$(this);switch(settings.mode){case"search":handler=new SearchHandler($this,settings);break;case"narrow":handler=new NarrowHandler($this,settings);break;case"collection":handler=new CollectionHandler($this,settings);break;case"tree":handler=new TreeHandler($this,settings);break;case"advanced":case"core":default:settings.mode="core",handler=new VocabHandler($this,settings)}"undefined"!=typeof handler?($this.data("_handler",handler),handler.ready()):_alert("Handler not initialised")})}catch(err){throw err}try{handler.detach()}catch(e){}return $(this).blur(),!1},function(){var initializing=!1,fnTest=/xyz/.test(function(){})?/\b_super\b/:/.*/;this.Class=function(){},Class.extend=function(prop){function Class(){!initializing&&this.init&&this.init.apply(this,arguments)}var _super=this.prototype;initializing=!0;var prototype=new this;initializing=!1;for(var name in prop)prototype[name]="function"==typeof prop[name]&&"function"==typeof _super[name]&&fnTest.test(prop[name])?function(name,fn){return function(){var tmp=this._super;this._super=_super[name];var ret=fn.apply(this,arguments);return this._super=tmp,ret}}(name,prop[name]):prop[name];return Class.prototype=prototype,Class.prototype.constructor=Class,Class.extend=arguments.callee,Class}}();var VocabHandler=Class.extend({init:function(container,settings){this._container=container,this.settings=settings,this._ctype=this._container.get(0).tagName},_mode:function(){try{return this.settings.mode}catch(err){return!1}},preconditions:function(){return[]},validate:function(settings){var options="undefined"==typeof settings?this.settings:settings,is_valid=!0,handler=this;return $.each(this.preconditions(),function(ridx,rule){return $.each(rule.fields,function(fidx,field){try{is_valid=is_valid&&rule.test(options[field])}catch(e){is_valid=!1}return is_valid?void 0:(handler._throwing(field,rule.description,options),!1)}),is_valid?void 0:!1}),is_valid},_throwing:function(val,rule,settings){throw"'"+val+"' must be "+rule+" (was: "+settings[val]+")"},ready:function(){return this.validate()?this.do_ready():!1},do_ready:function(){return!1},detach:function(){return!1},_err:function(xhr){if("boolean"==typeof this.settings.error_msg&&this.settings.error_msg===!1);else{var footer,cid=this._container.attr("id");footer="undefined"==typeof cid?"[Bound element has no id attribute; If you add one, I'll report it here.]":"(id: "+cid+")",alert(this.settings.error_msg+"\r\n"+xhr.responseText+"\r\n"+footer)}return this._container.blur(),!1},__url:function(mode,lookfor){("undefined"==typeof this.settings.repository||""===this.settings.repository)&&this._err({status:500,responseText:"No repository set"});var url=this.settings.endpoint+"?action="+mode+"&repository="+this.settings.repository+"&limit="+this.settings.max_results;return"undefined"!=typeof lookfor&&lookfor!==!1&&(url=url+"&lookfor="+lookfor),"undefined"!=typeof this.settings.sqc&&""!==this.settings.sqc&&(url=url+"&sqc="+this.settings.sqc,"undefined"!=typeof this.settings.sqc_op&&""!==this.settings.sqc_op&&(url=url+"&sqc_op="+this.settings.sqc_op)),url},_search:function(opts){this.__act("search",opts)},_narrow:function(opts){this.__act("narrow",opts)},_collection:function(opts){this.__act("collection",opts)},_top:function(opts){this.__act("top",opts)},__act:function(action,opts){var uri,callee,handler=this,uaction=action;"undefined"==typeof opts&&(opts=!1),uri="undefined"!=typeof opts.uri?opts.uri:opts,callee="undefined"!=typeof opts.callee?opts.callee:handler._container,opts.all===!0&&(uaction="all"+action),$.ajax({url:this.__url(uaction,uri),cache:this.settings.cache,dataType:"jsonp",success:function(data){callee.trigger(action+".vocab.ands",data)},error:function(xhr){callee.trigger("error.vocab.ands",xhr)}})}}),UIHandler=VocabHandler.extend({preconditions:function(){return[{fields:["min_chars","max_results","delay"],description:"a positive integer",test:function(val){return"number"==typeof val&&val===~~Number(val)&&val>=0}},{fields:["cache"],description:"a boolean",test:function(val){return"boolean"==typeof val}},{fields:["mode"],description:"one of <search,narrow,collection,tree,advanced>",test:function(val){return"search"===val||"narrow"===val||"collection"===val||"advanced"===val||"tree"===val}},{fields:["endpoint"],description:"a URL",test:function(val){return new RegExp("^(http|https)://.*$").test(val)}},{fields:["list_class","repository"],description:"a string",test:function(val){return"undefined"==typeof val||"string"==typeof val}}]},_makelist:function(persist){"undefined"==typeof persist&&(persist=!1),this._list=$("<ul />").attr("id",this._container.attr("id")+this.settings._wid).addClass(this.settings.list_class).addClass(this.settings.repository).addClass(this.mode).data("persist",persist).hide(),this._list.insertAfter(this._container),this._container.attr("autocomplete","off")},vocab_lookup:function(){this._container.data("vocab_timer")&&clearTimeout(this._container.data("vocab_timer"));var handler=this;this._container.data("vocab_timer",setTimeout(function(){handler.lookup()},handler.settings.delay))},_reset:function(){this._list.data("persist")||this._list.empty(),this._list.hide()},vocab_item:function(data){var item=$('<li role="vocab_item" />');return item.data(WIDGET_DATA,data),$.each(this.settings.fields,function(idx,field){"undefined"!=typeof data[field]&&item.append('<span role="'+field+'">'+data[field]+"</span>")}),item},handle_selection:function(event){var target=$(event.target),data=target.is("li")?target.data(WIDGET_DATA):target.parent().data(WIDGET_DATA);"undefined"!=typeof data[this.settings.target_field]?(this._container.val(data[this.settings.target_field]),$(this._container).trigger("blur"),this._reset()):this._err({status:404,responseText:"item is missing target field ("+this.settings.target_field+")"})}}),TreeHandler=VocabHandler.extend({preconditions:function(){var preconds=new Array;return preconds.push({fields:["repository"],description:"a string",test:function(val){return"undefined"==typeof val||"string"==typeof val}}),preconds.push({fields:["mode"],description:"mode 'tree'",test:function(val){return"tree"===val}}),preconds},detach:function(){this._container.empty()},do_ready:function(){var handler=this,elem=$("<div />"),treelist=$("<ul />").addClass("vocab_tree");elem.append(treelist),handler._container.on("narrow.vocab.ands",function(event,data){var subitem=$(event.target),sublist=$("<ul />");subitem.append(sublist),$.each(data.items,function(idx,item){handler._treeitems(sublist,idx,item)})}),handler._container.on("top.vocab.ands",function(event,data){$.each(data.items,function(idx,item){handler._treeitems(treelist,idx,item)})}),handler._top(),handler._container.append(elem)},_subclick:function(ev){var handler=this,fire=!0;ev.stopPropagation();var target=$(ev.target);target.is("span")&&(target=target.parent(),ev.target=target),target.is("ins")&&(target=target.parent(),ev.target=target,fire=!1);var itemdata=target.data("vocab");switch(target.data("treestate")){case"init":handler._narrow({uri:itemdata.about,callee:target}),target.removeClass("tree_closed").addClass("tree_open"),target.data("treestate","open");break;case"open":target.removeClass("tree_open").addClass("tree_closed"),target.find("ul").slideUp(100),target.data("treestate","closed");break;case"closed":target.removeClass("tree_closed").addClass("tree_open"),target.find("ul").slideDown(150),target.data("treestate","open")}target.is("li")&&fire===!0&&target.trigger("treeselect.vocab.ands",ev)},_treeitems:function(list,idx,item){var handler=this,titem=$("<li></li>"),icon=$("<ins/>");list.hide(),titem.data("treestate","init").addClass("tree_closed").data("vocab",item).attr("data-vocab-node",item.about),titem.html(this.settings.display_count?"<span>"+item.label+"</span> ("+item.count+")":"<span>"+item.label+"</span>"),item.narrower===!1&&titem.data("treestate","ignore").removeClass("tree_closed").addClass("tree_leaf"),titem.on("click",function(event){handler._subclick(event)}),0===item.count&&this.settings.display_count&&titem.addClass("tree_empty"),titem.prepend(icon),icon.on("click",function(e){e.preventDefault(),e.stopPropagation(),handler._subclick(e)}),list.append(titem).slideDown(150)}}),NarrowHandler=UIHandler.extend({preconditions:function(){var preconds=this._super();return preconds.push({fields:["mode_params"],description:"mode-specific parameters",test:function(val){return"undefined"!=typeof val}}),preconds.push({fields:["mode"],description:"mode 'narrow'",test:function(val){return"narrow"===val}}),preconds},init:function(container,settings){this._super(container,settings),this._container.is("select")?(this.settings.fields.length>1&&this._err({status:500,responseText:"'fields' setting must be a single element array when mode isn't 'search'"}),this._container.empty().append('<option value=""></option>')):this._container.is("input")?(this._makelist(!0),this._preplist()):this._err({status:500,responseText:"in 'narrow'/'collection' mode, the plugin must be attached to a select or input element"})},_preplist:function(){var handler=this;handler._container.one("narrow.vocab.ands",function(event,data){"OK"===data.status?$.each(data.items,function(idx,item){handler._list.append(handler.vocab_item(item))}):handler._err({status:500,responseText:data.message}),handler._container.bind("keyup",function(e){handler.vocab_lookup(e)}),handler._list.children('li[role="vocab_item"]').bind("click",function(event){handler.handle_selection(event)})}),handler._container.one("error.vocab.ands",function(event,xhr){handler._err(xhr)}),this.__call()},__call:function(callee){return"undefined"==typeof callee&&(callee=this._container),this._narrow({uri:this.settings.mode_params,callee:callee})},lookup:function(){var matches,handler=this,lookfor=this._container.val().toLowerCase();this._list.children("li").hide(),this._list.show(),matches=$.grep(this._list.children('li[role="vocab_item"]'),function(e){var item=$(e),data=item.data(WIDGET_DATA);for(var fi in handler.settings.fields){var field=handler.settings.fields[fi];if("undefined"!=typeof data[field]&&data[field].substring(0,lookfor.length).toLowerCase()===lookfor)return!0}return!1}),$(matches).show()},do_ready:function(){var handler=this;handler._container.on("error.vocab.ands",function(event,xhr){handler._err(xhr)}),"SELECT"===this._ctype?(handler._container.on("narrow.vocab.ands",function(event,data){handler.process(data)}),this.__call()):this._container.on("keydown",function(e){"40"==e.which?handler._list.show():"27"==e.which&&(handler._container.val(""),handler._list.hide())})},process:function(data){var handler=this;"OK"===data.status?$.each(data.items,function(idx,item){var val=item[handler.settings.target_field],label=item[handler.settings.fields[0]];handler._container.append('<option value="'+val+'">'+label+"</option>")}):handler._err({status:500,responseText:data.message})},detach:function(){"INPUT"===this._ctype&&this._container.unbind("keyup")}}),SearchHandler=UIHandler.extend({preconditions:function(){var preconds=this._super();return preconds.push({fields:["fields"],description:"an array of strings",test:function(val){return"[object Array]"===Object.prototype.toString.call(val)}}),preconds.push({fields:["mode"],description:"mode 'search'",test:function(val){return"search"===val}}),preconds},init:function(container,settings){return this._super(container,settings),this._makelist(),this._container.is("input[type='text']")?void this._container.attr("autocomplete","off"):(this._err({status:500,responseText:"must be attached to a text input element when mode is 'search'"}),!1)},do_ready:function(){var handler=this;this._container.bind("keydown",function(e){"27"==e.which?(handler._reset(),handler._container.val("")):handler.vocab_lookup(e)})},detach:function(){this._container.unbind("keydown")},process:function(data){var handler=this;"OK"!==data.status?this._err({status:500,responseText:data.message}):(this._reset(),0===data.count&&"boolean"!=typeof this.settings.nohits_msg&&typeof this.settings.nohits_msg!==!1?this._list.append('<li role="vocab_error">'+this.settings.nohits_msg+"</li>"):0===data.count&&"boolean"==typeof this.settings.nohits_msg&&this.settings.nohits_msg===!1?this._list.empty():data.count>0?$.each(data.items,function(idx,item){handler._list.append(handler.vocab_item(item))}):this._list.append('<li role="vocab_error">Hmmm... something went wrong here. Try again?</li>'),this._list.show().children('li[role="vocab_item"]').bind("click",function(event){handler.handle_selection(event)}))},lookup:function(){if(this._container.val().length>=this.settings.min_chars){{var handler=this;this.settings.endpoint+"?action="+this.settings.mode+"&repository="+this.settings.repository+"&limit="+this.settings.max_results+"&lookfor="+this._container.val()}handler._container.on("search.vocab.ands",function(event,data){handler.process(data)}),handler._container.on("error.vocab.ands",function(event,xhr){handler._err(xhr)}),handler._search({callee:this._container,uri:this._container.val()})}}}),CollectionHandler=NarrowHandler.extend({preconditions:function(){var preconds=this.__proto__.__proto__.__proto__.preconditions();return preconds.push({fields:["mode_params"],description:"mode-specific parameters",test:function(val){return"undefined"!=typeof val}}),preconds.push({fields:["mode"],description:"mode 'collection'",test:function(val){return"collection"===val}}),preconds},__call:function(callee){return"undefined"==typeof callee&&(callee=this._container),this._collection({uri:this.settings.mode_params,callee:callee})},do_ready:function(){var handler=this;handler._container.on("error.vocab.ands",function(event,xhr){handler._err(xhr)}),"SELECT"===this._ctype?(handler._container.on("collection.vocab.ands",function(event,data){handler.process(data)}),this.__call()):this._container.on("keydown",function(e){"40"==e.which?handler._list.show():"27"==e.which&&(handler._container.val(""),handler._list.hide())})}})}(jQuery);